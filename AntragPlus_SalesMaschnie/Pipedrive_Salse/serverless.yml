service: pipedrive-sales-sync

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    STAGE: ${self:provider.stage}
    NODE_ENV: ${self:provider.stage}
    PIPEDRIVE_API_TOKEN: ${env:PIPEDRIVE_API_TOKEN}
    ASANA_CLIENT_ID: ${env:ASANA_CLIENT_ID}
    ASANA_CLIENT_SECRET: ${env:ASANA_CLIENT_SECRET}
    ASANA_ACCESS_TOKEN: ${env:ASANA_ACCESS_TOKEN}
    ASANA_WORKSPACE_ID: ${env:ASANA_WORKSPACE_ID}
    DATABASE_URL: ${env:DATABASE_URL}
    WEBHOOK_SECRET: ${env:WEBHOOK_SECRET}

functions:
  sync:
    handler: src/sync.handler
    events:
      - schedule: rate(5 minutes)
    timeout: 300

  backfill:
    handler: src/backfill.handler
    timeout: 900

  pipedriveWebhook:
    handler: src/pdWebhook.handler
    events:
      - http:
          path: webhook/pipedrive
          method: post
          cors: true

  asanaWebhook:
    handler: src/asanaWebhook.handler
    events:
      - http:
          path: webhook/asana
          method: post
          cors: true

  cleanup:
    handler: src/cleanup.handler
    timeout: 900

plugins:
  - serverless-esbuild

custom:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude: ['pg-native']
    external: ['undici', 'pg-native']
    target: 'node20'
    platform: 'node'
    concurrency: 10
