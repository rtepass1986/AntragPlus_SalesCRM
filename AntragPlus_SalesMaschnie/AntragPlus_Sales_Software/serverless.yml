service: antragplus-sales-software

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    STAGE: ${self:provider.stage}
    NODE_ENV: ${self:provider.stage}
    # Pipedrive
    PIPEDRIVE_API_TOKEN: ${env:PIPEDRIVE_API_TOKEN}
    # Asana
    ASANA_CLIENT_ID: ${env:ASANA_CLIENT_ID}
    ASANA_CLIENT_SECRET: ${env:ASANA_CLIENT_SECRET}
    ASANA_ACCESS_TOKEN: ${env:ASANA_ACCESS_TOKEN}
    ASANA_WORKSPACE_ID: ${env:ASANA_WORKSPACE_ID}
    # Database
    DATABASE_URL: ${env:DATABASE_URL}
    # Security
    WEBHOOK_SECRET: ${env:WEBHOOK_SECRET}
    # OpenAI (for lead enrichment)
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    # Tavily (for web search)
    TAVILY_API_KEY: ${env:TAVILY_API_KEY, ''}

functions:
  # === SYNC ENGINE ===
  sync:
    handler: src/sync/index.handler
    events:
      - schedule: rate(5 minutes)
    timeout: 300
    description: Scheduled sync between Pipedrive and Asana

  backfill:
    handler: src/sync/backfill.handler
    timeout: 900
    description: Initial data migration from Pipedrive to Asana

  pipedriveWebhook:
    handler: src/sync/pdWebhook.handler
    events:
      - http:
          path: webhook/pipedrive
          method: post
          cors: true
    description: Handle Pipedrive webhook events

  asanaWebhook:
    handler: src/sync/asanaWebhook.handler
    events:
      - http:
          path: webhook/asana
          method: post
          cors: true
    description: Handle Asana webhook events

  cleanup:
    handler: src/sync/cleanup.handler
    timeout: 900
    description: Clean up Asana tasks

  # === LEAD ENGINE ===
  enrichLeads:
    handler: src/lead/enrich-pipedrive.handler
    timeout: 900
    events:
      - schedule: rate(1 day)
    description: Daily lead enrichment batch

  enrichLeadership:
    handler: src/lead/enrich-with-leadership.handler
    timeout: 900
    description: Extract leadership data for leads

  # === AUTOMATION ENGINE ===
  applyRules:
    handler: src/automation/index.handler
    timeout: 300
    description: Apply automation rules to deals

plugins:
  - serverless-esbuild

custom:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude: ['pg-native', 'playwright']
    external: ['undici', 'pg-native', 'playwright']
    target: 'node20'
    platform: 'node'
    concurrency: 10

